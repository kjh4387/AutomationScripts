import tkinter as tk
import logging
import DataHandler
from tkinter import ttk, messagebox
import re

logger = logging.getLogger(__name__)
user_data = DataHandler.user_data()
mail_data = DataHandler.mail_data()
mail_template = DataHandler.mail_template()

def prompt_user_data():
    def submit_user_data():
        email = id_entry.get()
        password = pw_entry.get()

        if not is_valid_email(email):
            messagebox.showerror("Invalid Input", "Please enter a valid email address.")
            return
        if not password:
            messagebox.showerror("Invalid Input", "Password cannot be empty.")
            return

        user_data.put_address(email)
        user_data.put_password(password)
        root.destroy()

    # Create the main window
    root = tk.Tk()
    root.title("메일 주소 변경")

    # Create a frame to hold the widgets
    frame = ttk.Frame(root, padding="10")
    frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

    # ID label and entry
    id_label = ttk.Label(frame, text="ID:")
    id_label.grid(row=0, column=0, sticky=tk.W, pady=5)
    id_entry = ttk.Entry(frame, width=20)
    id_entry.grid(row=0, column=1, pady=5)

    # Password label and entry
    pw_label = ttk.Label(frame, text="Password:")
    pw_label.grid(row=1, column=0, sticky=tk.W, pady=5)
    pw_entry = ttk.Entry(frame, width=20, show="*")  # 'show="*"' masks the password
    pw_entry.grid(row=1, column=1, pady=5)

    # Submit button
    submit_btn = ttk.Button(frame, text="적용", command=submit_user_data)
    submit_btn.grid(row=2, column=0, columnspan=2, pady=10)

    root.mainloop()


def prompt_mail_data():
    def submit_mail_data():
        server = server_entry.get()
        port = port_entry.get()

        if not server:
            messagebox.showerror("Invalid Input", "SMTP server cannot be empty.")
            return
        if not is_valid_port(port):
            messagebox.showerror("Invalid Input", "Please enter a valid port number.")
            return

        mail_data.put_mailhost(server)
        mail_data.put_mailport(port)
        root.destroy()

    # Create the main window
    root = tk.Tk()
    root.title("메일 공급자 변경")

    # Create a frame to hold the widgets
    frame = ttk.Frame(root, padding="10")
    frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

    # ID label and entry
    id_label = ttk.Label(frame, text="smtp server:")
    id_label.grid(row=0, column=0, sticky=tk.W, pady=5)
    server_entry = ttk.Entry(frame, width=20)
    server_entry.grid(row=0, column=1, pady=5)

    # Password label and entry
    port_label = ttk.Label(frame, text="port(465 in general):")
    port_label.grid(row=1, column=0, sticky=tk.W, pady=5)
    port_entry = ttk.Entry(frame, width=20)  
    port_entry.grid(row=1, column=1, pady=5)

    # Submit button
    submit_btn = ttk.Button(frame, text="적용", command=submit_mail_data)
    submit_btn.grid(row=2, column=0, columnspan=2, pady=10)

    root.mainloop()

def prompt_template_data():
    def submit_template_data():
        period = period_entry.get()
        manager = manager_entry.get()

        if not period:
            messagebox.showerror("Invalid Input", "Posting period cannot be empty.")
            return
        if not manager:
            messagebox.showerror("Invalid Input", "Manager information cannot be empty.")
            return

        mail_template.put_postingperiod(period)
        mail_template.put_manager(manager)
        root.destroy()

    # Create the main window
    root = tk.Tk()
    root.title("메일 내용 지정")

    # Create a frame to hold the widgets
    frame = ttk.Frame(root, padding="10")
    frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

    period_label = ttk.Label(frame, text="게시기간:")
    period_label.grid(row=0, column=0, sticky=tk.W, pady=5)
    period_entry = ttk.Entry(frame, width=20)
    period_entry.grid(row=0, column=1, pady=5)

    manager_label = ttk.Label(frame, text="담당자(내선번호):")
    manager_label.grid(row=1, column=0, sticky=tk.W, pady=5)
    manager_entry = ttk.Entry(frame, width=20)  
    manager_entry.grid(row=1, column=1, pady=5)

    # Submit button
    submit_btn = ttk.Button(frame, text="적용", command=submit_template_data)
    submit_btn.grid(row=2, column=0, columnspan=2, pady=10)

    root.mainloop()

def is_valid_email(email):
    pattern = r"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$"
    return re.match(pattern, email)

def is_valid_port(port):
    try:
        port_num = int(port)
        return 0 <= port_num <= 65535
    except ValueError:
        return False
